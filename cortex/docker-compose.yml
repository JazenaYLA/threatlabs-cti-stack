services:
  cortex:
    image: thehiveproject/cortex:latest #original version 4.0.0
    container_name: cortex-cti
    restart: unless-stopped
    volumes:
      - ./vol/cortex/application.conf:/etc/cortex/application.conf:ro
      - ${JOB_DIRECTORY:-/opt/cortex/jobs}:/opt/cortex/jobs
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "${CORTEX_PORT:-9001}:9001"
    environment:
      - job_directory=/opt/cortex/jobs
      - job_directory=/opt/cortex/jobs
      - es_uri=http://es8-cti:9200 # Infra ES8 (Shared)
      - CORTEX_SECRET=${CORTEX_SECRET}
    networks:
      - cti-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9001/api/status" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      # Optional: Traefik Reverse Proxy (Auto-Discovery)
      # Can be ignored if using Nginx/Caddy/etc via port 9001
      - "traefik.enable=true"
      - "traefik.http.routers.cortex.rule=Host(`cortex.local`)"
      - "traefik.http.services.cortex.loadbalancer.server.port=9001"

networks:
  cti-net:
    external: true
    name: cti-net
