services:
  lacus:
    build: https://github.com/ail-project/lacus.git#main
    image: lacus:local
    container_name: lacus
    restart: unless-stopped
    ports:
      - "${LACUS_PORT:-7100}:7100" # Lacus API/Web UI
    volumes:
      - ./vol/lacus-data:/lacus/data
      - ./vol/lacus-cache:/lacus/cache
    environment:
      - LACUS_HOME=/lacus
      - REDIS_HOST=valkey
      - REDIS_PORT=6379
      - PW_TEST_SCREENSHOT_NO_FONTS_READY=1
      - PLAYWRIGHT_CHROMIUM_USE_HEADLESS_NEW=1
    depends_on:
      - valkey
    networks:
      - cti-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:7100" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s # Playwright installation takes time

  valkey:
    image: valkey/valkey:latest
    container_name: lacus-valkey
    restart: unless-stopped
    volumes:
      - ./vol/valkey:/data
    networks:
      - cti-net

networks:
  cti-net:
    external: true
    name: cti-net
