services:

  ###########################
  # DEPENDENCIES            #
  ###########################

  # Generate RSA key for xtm-composer (PKCS#8 format)
  rsa-key-generator:
    image: alpine/openssl:3.5.4
    volumes:
      - rsakeys:/keys
    entrypoint: [ "/bin/ash" ]
    command: [ "-c", "if [ ! -f /keys/private_key.pem ]; then openssl genpkey -algorithm RSA -out /keys/private_key.pem -pkeyopt rsa_keygen_bits:4096; fi && tail -f /dev/null" ]
    healthcheck:
      test: [ "CMD", "test", "-f", "/keys/private_key.pem" ]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: always
  # redis: REMOVED - Using shared infra-valkey
  # pgsql: REMOVED - Using shared infra-postgres
  minio:
    image: minio/minio:RELEASE.2025-06-13T11-33-47Z
    volumes:
      - s3data:/data
    #  ports:
    #    - "9000:9000"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    command: server /data
    restart: always
    healthcheck:
      test: [ "CMD", "mc", "ready", "local" ]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - cti-net
  rabbitmq:
    image: rabbitmq:4.2-management
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS}
    #  - RABBITMQ_NODENAME=rabbit01@localhost
    #ports:
    #  - "5672:5672"
    #  - "15672:15672"      
    volumes:
      - type: bind
        source: ./rabbitmq.conf
        target: /etc/rabbitmq/rabbitmq.conf
      - amqpdata:/var/lib/rabbitmq
    restart: always
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 30s
      retries: 3
    networks:
      - cti-net

  ###########################
  # COMMON                  #
  ###########################

  xtm-composer:
    image: filigran/xtm-composer:latest
    platform: linux/amd64
    environment:
      - MANAGER__ID=${XTM_COMPOSER_ID}
      - MANAGER__NAME=OpenCTI Connector Manager
      - MANAGER__CREDENTIALS_KEY_FILEPATH=/keys/private_key.pem
      - OPENCTI__ENABLE=true
      - OPENCTI__URL=http://opencti:8080
      - OPENCTI__TOKEN=${OPENCTI_ADMIN_TOKEN}
      - OPENCTI__DAEMON__SELECTOR=docker
      - OPENCTI__DAEMON__DOCKER__NETWORK_MODE=${COMPOSE_PROJECT_NAME}_default
      - OPENAEV__ENABLE=true
      - OPENAEV__URL=http://openaev:8080
      - OPENAEV__TOKEN=${OPENCTI_ADMIN_TOKEN}
      - OPENAEV__DAEMON__SELECTOR=docker
      - OPENAEV__DAEMON__DOCKER__NETWORK_MODE=${COMPOSE_PROJECT_NAME}_default
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - rsakeys:/keys:ro # RSA key mounted as read-only
    depends_on:
      rsa-key-generator:
        condition: service_healthy
      opencti:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      openaev:
        condition: service_healthy
    networks:
      - cti-net
    restart: always

  ###########################
  # OPENCTI                 #
  ###########################

  opencti:
    image: opencti/platform:latest
    environment:
      - NODE_OPTIONS=--max-old-space-size=8096
      - APP__PORT=8080
      - APP__BASE_URL=${OPENCTI_EXTERNAL_SCHEME}://${OPENCTI_HOST}:${OPENCTI_PORT}
      - APP__ADMIN__EMAIL=${OPENCTI_ADMIN_EMAIL}
      - APP__ADMIN__PASSWORD=${OPENCTI_ADMIN_PASSWORD}
      - APP__ADMIN__TOKEN=${OPENCTI_ADMIN_TOKEN}
      - APP__APP_LOGS__LOGS_LEVEL=error
      - REDIS__HOSTNAME=infra-valkey
      - REDIS__PORT=6379
      - MINIO__ENDPOINT=minio
      - MINIO__PORT=9000
      - MINIO__USE_SSL=false
      - MINIO__ACCESS_KEY=${MINIO_ROOT_USER}
      - MINIO__SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - RABBITMQ__HOSTNAME=rabbitmq
      - RABBITMQ__PORT=5672
      - RABBITMQ__PORT_MANAGEMENT=15672
      - RABBITMQ__MANAGEMENT_SSL=false
      - RABBITMQ__USERNAME=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ__PASSWORD=${RABBITMQ_DEFAULT_PASS}
      - SMTP__HOSTNAME=${SMTP_HOST}
      - SMTP__PORT=25
      - PROVIDERS__LOCAL__STRATEGY=LocalStrategy
      - APP__HEALTH_ACCESS_KEY=${OPENCTI_HEALTHCHECK_ACCESS_KEY}
      # OpenAEV integration
      - XTM__OPENAEV_URL=${OPENAEV_EXTERNAL_SCHEME}://${OPENAEV_HOST}:${OPENAEV_PORT}
      - XTM__OPENAEV_API_URL=http://openaev:8080
      - XTM__OPENAEV_TOKEN=${OPENAEV_ADMIN_TOKEN}
      # Shared ElasticSearch 8.x from 'infra' stack
      - ELASTICSEARCH__URL=http://es8-cti:9200
      - ELASTICSEARCH__NUMBER_OF_REPLICAS=0
    ports:
      - "${OPENCTI_PORT}:8080"
    depends_on:
      # redis: REMOVED (Shared Infra)
      #   condition: service_healthy
      # ES is now infra CTI stack  
      # elasticsearch:
      #   condition: service_healthy
      minio:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: always
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://opencti:8080/health?health_access_key=${OPENCTI_HEALTHCHECK_ACCESS_KEY}" ]
      interval: 10s
      timeout: 5s
      retries: 20
    networks:
      - cti-net
  worker:
    image: opencti/worker:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
    depends_on:
      opencti:
        condition: service_healthy
    deploy:
      mode: replicated
      replicas: 3
    restart: always
    networks:
      - cti-net

  ###########################
  # OPENCTI CONNECTORS      #
  ###########################

  connector-export-file-stix:
    image: opencti/connector-export-file-stix:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_EXPORT_FILE_STIX_ID} # Valid UUIDv4
      - CONNECTOR_TYPE=INTERNAL_EXPORT_FILE
      - CONNECTOR_NAME=ExportFileStix2
      - CONNECTOR_SCOPE=application/json
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    networks:
      - cti-net
  connector-export-file-csv:
    image: opencti/connector-export-file-csv:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_EXPORT_FILE_CSV_ID} # Valid UUIDv4
      - CONNECTOR_TYPE=INTERNAL_EXPORT_FILE
      - CONNECTOR_NAME=ExportFileCsv
      - CONNECTOR_SCOPE=text/csv
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    networks:
      - cti-net
  connector-export-file-txt:
    image: opencti/connector-export-file-txt:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_EXPORT_FILE_TXT_ID} # Valid UUIDv4
      - CONNECTOR_TYPE=INTERNAL_EXPORT_FILE
      - CONNECTOR_NAME=ExportFileTxt
      - CONNECTOR_SCOPE=text/plain
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    networks:
      - cti-net
  connector-import-file-stix:
    image: opencti/connector-import-file-stix:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_IMPORT_FILE_STIX_ID} # Valid UUIDv4
      - CONNECTOR_TYPE=INTERNAL_IMPORT_FILE
      - CONNECTOR_NAME=ImportFileStix
      - CONNECTOR_VALIDATE_BEFORE_IMPORT=true # Validate any bundle before import
      - CONNECTOR_SCOPE=application/json,text/xml
      - CONNECTOR_AUTO=true # Enable/disable auto-import of file
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    networks:
      - cti-net
  connector-import-document:
    image: opencti/connector-import-document:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_IMPORT_DOCUMENT_ID} # Valid UUIDv4
      - CONNECTOR_TYPE=INTERNAL_IMPORT_FILE
      - CONNECTOR_NAME=ImportDocument
      - CONNECTOR_VALIDATE_BEFORE_IMPORT=true # Validate any bundle before import
      - CONNECTOR_SCOPE=application/pdf,text/plain,text/html
      - CONNECTOR_AUTO=true # Enable/disable auto-import of file
      - CONNECTOR_ONLY_CONTEXTUAL=false # Only extract data related to an entity (a report, a threat actor, etc.)
      - IMPORT_DOCUMENT_CREATE_INDICATOR=true
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    networks:
      - cti-net
  connector-import-file-yara:
    image: opencti/connector-import-file-yara:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_IMPORT_FILE_YARA_ID} # Valid UUIDv4
      - CONNECTOR_NAME=ImportFileYARA
      - CONNECTOR_VALIDATE_BEFORE_IMPORT=true # Validate any bundle before import
      - CONNECTOR_SCOPE=text/yara+plain
      - CONNECTOR_AUTO=false # Enable/disable auto-import of file
      - CONNECTOR_TYPE=INTERNAL_IMPORT_FILE # JAMZ ADDED THIS LINE
      - YARA_IMPORT_FILE_SPLIT_RULES=true
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    networks:
      - cti-net
  connector-analysis:
    image: opencti/connector-import-document:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_ANALYSIS_ID} # Valid UUIDv4
      - CONNECTOR_TYPE=INTERNAL_ANALYSIS
      - CONNECTOR_NAME=ImportDocumentAnalysis
      - CONNECTOR_VALIDATE_BEFORE_IMPORT=false # Validate any bundle before import
      - CONNECTOR_SCOPE=application/pdf,text/plain,text/html
      - CONNECTOR_AUTO=true # Enable/disable auto-import of file
      - CONNECTOR_ONLY_CONTEXTUAL=false # Only extract data related to an entity (a report, a threat actor, etc.)
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    networks:
      - cti-net
  connector-import-external-reference:
    image: opencti/connector-import-external-reference:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_IMPORT_EXTERNAL_REFERENCE_ID}
      - CONNECTOR_NAME=ImportExternalReference
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    networks:
      - cti-net
  connector-misp:
    image: opencti/connector-misp:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_MISP_ID}
      - CONNECTOR_NAME=MISP
      - CONNECTOR_SCOPE=misp
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_DURATION_PERIOD=PT5M
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - MISP_URL=${CONNECTOR_MISP_URL} # http://example.com
      - MISP_KEY=${CONNECTOR_MISP_KEY}
      - MISP_SSL_VERIFY=false
      - MISP_CLIENT_CERT=
      - MISP_REFERENCE_URL=${CONNECTOR_MISP_URL}
      - MISP_DATE_FILTER_FIELD=date_from
      - MISP_DATETIME_ATTRIBUTE=date
      - MISP_CREATE_REPORTS=true
      - MISP_CREATE_INDICATORS=true
      - MISP_CREATE_OBSERVABLES=true
      - MISP_CREATE_OBJECT_OBSERVABLES=true
      - MISP_REPORT_DESCRIPTION_ATTRIBUTE_FILTER=
      - MISP_CREATE_TAGS_AS_LABELS=true
      - MISP_GUESS_THREATS_FROM_TAGS=false
      - MISP_AUTHOR_FROM_TAGS=false
      - MISP_MARKINGS_FROM_TAGS=false
      - MISP_KEEP_ORIGINAL_TAGS_AS_LABEL=
      - MISP_ENFORCE_WARNING_LIST=false
      - MISP_REPORT_TYPE=misp-event
      - MISP_IMPORT_FROM_DATE=${MISP_IMPORT_FROM_DATE:-2020-01-01}
      - MISP_IMPORT_TAGS=openctiimport,type:osint
      - MISP_IMPORT_TAGS_NOT=
      - MISP_IMPORT_CREATOR_ORGS=
      - MISP_IMPORT_CREATOR_ORGS_NOT=
      - MISP_IMPORT_OWNER_ORGS=
      - MISP_IMPORT_OWNER_ORGS_NOT=
      - MISP_IMPORT_KEYWORD=
      - MISP_IMPORT_DISTRIBUTION_LEVELS=0,1,2,3
      - MISP_IMPORT_THREAT_LEVELS=1,2,3,4
      - MISP_IMPORT_ONLY_PUBLISHED=false
      - MISP_IMPORT_WITH_ATTACHMENTS=false
      - MISP_IMPORT_TO_IDS_NO_SCORE=40
      - MISP_IMPORT_UNSUPPORTED_OBSERVABLES_AS_TEXT=false
      - MISP_IMPORT_UNSUPPORTED_OBSERVABLES_AS_TEXT_TRANSPARENT=true
      - MISP_PROPAGATE_LABELS=false
      - MISP_BATCH_COUNT=9999
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    networks:
      - cti-net
  connector-thehive:
    image: opencti/connector-thehive:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_THEHIVE_ID}
      - CONNECTOR_NAME=TheHive
      - CONNECTOR_SCOPE=thehive
      - CONNECTOR_LOG_LEVEL=error
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - THEHIVE_URL=${CONNECTOR_THEHIVE_URL}
      - THEHIVE_API_KEY=${CONNECTOR_THEHIVE_KEY}
      - THEHIVE_CHECK_SSL=true
      - THEHIVE_ORGANIZATION_NAME=${XTM_ORGANIZATION_NAME}
      - THEHIVE_IMPORT_FROM_DATE=2025-06-01T00:00:00 # Optional
      - THEHIVE_IMPORT_ONLY_TLP=0,1,2,3,4
      - THEHIVE_IMPORT_ALERTS=true
      - "THEHIVE_SEVERITY_MAPPING=1:low,2:medium,3:high,4:critical"
      - THEHIVE_CASE_STATUS_MAPPING= # TheHive_ExtStatus_Text1:OpenCTI_Status_ID1,TheHive_ExtStatus_Text2:OpenCTI_Status_ID2
      - THEHIVE_TASK_STATUS_MAPPING= # Waiting:OpenCTI_Status_ID1,InProgress:OpenCTI_Status_ID2,Completed:OpenCTI_Status_ID2
      - THEHIVE_ALERT_STATUS_MAPPING= # TheHive_ExtStatus_Text1:OpenCTI_Status_ID1,TheHive_ExtStatus_Text2:OpenCTI_Status_ID2
      - THEHIVE_USER_MAPPING= # Format: TheHive_Assignee_Email1:OpenCTI_User_ID1,TheHive_Assignee_Email2:OpenCTI_User_ID2
      - THEHIVE_INTERVAL=5 # In minutes
      - THEHIVE_CASE_TAG_WHITELIST= # TAG_OK,TAG_GOOD
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    networks:
      - cti-net
  connector-alienvault:
    image: opencti/connector-alienvault:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_OTX_ID} # Optional (default: 8bbae241-6289-4faf-b7d6-7503bed50bbc)
      - CONNECTOR_NAME=AlienVault # Optional (default: AlienVault)
      - CONNECTOR_SCOPE=alienvault # Optional (default: alienvault)
      - CONNECTOR_LOG_LEVEL=error # Optional (default: error)
      - CONNECTOR_DURATION_PERIOD=PT30M # Optional (default: PT30M) - ISO8601 Format starting with "P" for Period ex: "PT30M" = Period time of 30 minutes
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - ALIENVAULT_BASE_URL=${CONNECTOR_OTX_URL} # Optional (default: https://otx.alienvault.com)
      - ALIENVAULT_API_KEY=${CONNECTOR_OTX_KEY} # Required
      - ALIENVAULT_TLP=White # Optional (default: White)
      - ALIENVAULT_CREATE_OBSERVABLES=true # Optional (default: true)
      - ALIENVAULT_CREATE_INDICATORS=true # Optional (default: true)
      - ALIENVAULT_PULSE_START_TIMESTAMP=2025-06-01T00:00:00 # Optional (default: 2020-05-01T00:00:00) - ISO 8601 format, UTC - BEWARE! Could be a lot of pulses!
      - ALIENVAULT_REPORT_TYPE=threat-report # Optional (default: threat-report)
      - ALIENVAULT_REPORT_STATUS=New # Optional (default: New) - New, In progress, Analyzed and Closed
      - ALIENVAULT_GUESS_MALWARE=false # Optional (default: false) - Use tags to guess malware
      - ALIENVAULT_GUESS_CVE=false # Optional (default: false) - Use tags to guess CVE
      - ALIENVAULT_EXCLUDED_PULSE_INDICATOR_TYPES=FileHash-MD5,FileHash-SHA1 # Optional (default: "") - Comma-separated list of Pulse indicator types to exclude
      - ALIENVAULT_ENABLE_RELATIONSHIPS=true # Optional (default: true) - Enable/Disable relationship creation between SDOs
      - ALIENVAULT_ENABLE_ATTACK_PATTERNS_INDICATES=true # Optional (default: true) - Enable/Disable "indicates" relationships between indicators and attack patterns
      - ALIENVAULT_FILTER_INDICATORS=false # Optional (default: false) - Filter indicators by their created datetime
      - ALIENVAULT_DEFAULT_X_OPENCTI_SCORE=50 # Optional (default: 50) - The default x_opencti_score to use for indicators
      - ALIENVAULT_X_OPENCTI_SCORE_IP=60 # Optional (default: uses default_x_opencti_score) - The x_opencti_score to use for IP indicators
      - ALIENVAULT_X_OPENCTI_SCORE_DOMAIN=70 # Optional (default: uses default_x_opencti_score) - The x_opencti_score to use for Domain indicators
      - ALIENVAULT_X_OPENCTI_SCORE_HOSTNAME=75 # Optional (default: uses default_x_opencti_score) - The x_opencti_score to use for Hostname indicators
      - ALIENVAULT_X_OPENCTI_SCORE_EMAIL=70 # Optional (default: uses default_x_opencti_score) - The x_opencti_score to use for Email indicators
      - ALIENVAULT_X_OPENCTI_SCORE_FILE=80 # Optional (default: uses default_x_opencti_score) - The x_opencti_score to use for StixFile indicators
      - ALIENVAULT_X_OPENCTI_SCORE_URL=80 # Optional (default: uses default_x_opencti_score) - The x_opencti_score to use for URL indicators
      - ALIENVAULT_X_OPENCTI_SCORE_MUTEX=60 # Optional (default: uses default_x_opencti_score) - The x_opencti_score to use for Mutex indicators
      - ALIENVAULT_X_OPENCTI_SCORE_CRYPTOCURRENCY_WALLET=80 # Optional (default: uses default_x_opencti_score) - The x_opencti_score to use for Cryptocurrency Wallet indicators
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    networks:
      - cti-net
  connector-cisa-known-exploited-vulnerabilities:
    image: opencti/connector-cisa-known-exploited-vulnerabilities:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    networks:
      - cti-net

  #  connector-cape:
  #    image: opencti/connector-cape:latest
  #    environment:
  #      - OPENCTI_URL=http://opencti:8080
  #      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
  #      - CONNECTOR_ID=${CONNECTOR_CAPE_ID} 
  #      - CONNECTOR_NAME=CAPE
  #      - CONNECTOR_LOG_LEVEL=error
  #      - CONNECTOR_TYPE=EXTERNAL_IMPORT      
  #      - CAPE_CREATE_INDICATORS=true
  #      - CAPE_ENABLE_NETWORK_TRAFFIC=false # enable creation of net Traffic (Very Loud)
  #      - CAPE_ENABLE_REGISTRY_KEYS=false # enable creation of Created registry Keys (Very Loud)
  #      - CAPE_API_URL=${CONNECTOR_CAPE_URL}/apiv2/ # CAPE API EP
  #      - CAPE_BASE_URL=${CONNECTOR_CAPE_URL}/ # CAPE Web UI URL
  #      - CAPE_INTERVAL=30 #in Min
  #      - CAPE_START_TASK_ID=0 #in Min
  #      - CAPE_REPORT_SCORE=7
  #      - VERIFY_SSL=true
  #    restart: always
  #    depends_on:
  #      opencti:
  #        condition: service_healthy          
  #    networks:
  #      - cti-net

  connector-malpedia:
    image: opencti/connector-malpedia:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_MALPEDIA_ID} # Optional (default: '8a277536-ca52-4d87-9f8e-4f77e3e6512c')
      - CONNECTOR_NAME=Malpedia # Optional (default: 'Malpedia')
      - CONNECTOR_SCOPE=malpedia # Optional (default: ['malpedia'])
      - CONNECTOR_LOG_LEVEL=info # Optional (default: 'error')
      - CONNECTOR_DURATION_PERIOD=PT24H # Optional (default: 24 hours)
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - MALPEDIA_AUTH_KEY=${CONNECTOR_MALPEDIA_KEY} # Optional (default: none)
      - MALPEDIA_IMPORT_INTRUSION_SETS=true # Optional (default: true)
      - MALPEDIA_IMPORT_YARA=true # Optional (default: true)
      - MALPEDIA_CREATE_INDICATORS=true # Optional (default: true)
      - MALPEDIA_CREATE_OBSERVABLES=true # Optional (default: true)
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    networks:
      - cti-net

  connector-malwarebazaar:
    image: opencti/connector-malwarebazaar:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_MALWAREBAZAAR_ID}
      - CONNECTOR_NAME=MalwareBazaar
      - CONNECTOR_SCOPE=StixFile
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_DURATION_PERIOD=PT50M
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - MALWAREBAZAAR_API_BASE_URL=https://mb-api.abuse.ch/api/v1/
      - MALWAREBAZAAR_API_KEY=${CONNECTOR_MALWAREBAZAAR_KEY}
      - MALWAREBAZAAR_TLP_LEVEL=clear
      - MALWAREBAZAAR_X_OPENCTI_SCORE=100
      - MALWAREBAZAAR_INCLUDE_TAGS=exe,dll,docm,docx,doc,xls,xlsx,xlsm,js
      - MALWAREBAZAAR_INCLUDE_REPORTERS=
      - MALWAREBAZAAR_LABELS=malware-bazaar
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    networks:
      - cti-net
  connector-malwarebazaar-recent-additions:
    image: opencti/connector-malwarebazaar-recent-additions:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_MALWAREBAZAAR_RECENT_ID}
      - "CONNECTOR_NAME=MalwareBazaar Recent Additions"
      - CONNECTOR_LOG_LEVEL=error
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - MALWAREBAZAAR_RECENT_ADDITIONS_API_URL=https://mb-api.abuse.ch/api/v1/
      - MALWAREBAZAAR_RECENT_ADDITIONS_API_KEY=${CONNECTOR_MALWAREBAZAAR_RECENT_KEY} # Required, issued for free by MalwareBazaar - https://bazaar.abuse.ch/api/#auth_key
      - MALWAREBAZAAR_RECENT_ADDITIONS_COOLDOWN_SECONDS=300 # Time to wait in seconds between subsequent requests
      - MALWAREBAZAAR_RECENT_ADDITIONS_INCLUDE_TAGS=exe,dll,docm,docx,doc,xls,xlsx,xlsm,js # (Optional) Only download files if any tag matches. (Comma separated)
      - MALWAREBAZAAR_RECENT_ADDITIONS_INCLUDE_REPORTERS= # (Optional) Only download files uploaded by these reporters. (Comma separated)
      - MALWAREBAZAAR_RECENT_ADDITIONS_LABELS=malware-bazaar # (Optional) Labels to apply to uploaded Artifacts. (Comma separated)
      - MALWAREBAZAAR_RECENT_ADDITIONS_LABELS_COLOR=#54483b # Color to use for labels
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    networks:
      - cti-net

  connector-shodan:
    image: opencti/connector-shodan:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_SHODAN_ID} # Optional (default: '82b58916-a654-4cd4-81de-700eb72a5c94')
      - CONNECTOR_NAME=Shodan # Optional (default: 'Shodan')
      - CONNECTOR_SCOPE=ipv4-addr,indicator # Optional (default: ['ipv4-addr', 'indicator'])
      - CONNECTOR_AUTO=true # Optional (default: false)
      - CONNECTOR_LOG_LEVEL=info # Optional (default: error)
      - CONNECTOR_TYPE=INTERNAL_ENRICHMENT
      - SHODAN_TOKEN=${CONNECTOR_SHODAN_KEY}
      - SHODAN_MAX_TLP=TLP:AMBER # Optional (default: 'TLP:AMBER')
      - SHODAN_DEFAULT_SCORE=50 # Optional (default: 50)
      - SHODAN_IMPORT_SEARCH_RESULTS=true # Optional (default: true)
      - SHODAN_CREATE_NOTE=true # Optional (default: true)
      - SHODAN_USE_ISP_NAME_FOR_ASN=false # Optional (default: false)
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    networks:
      - cti-net

  connector-malbeacon:
    image: opencti/connector-malbeacon:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_MALBEACON_ID}
      - CONNECTOR_NAME=Malbeacon
      - CONNECTOR_AUTO=false # Enable/disable auto-enrichment of observables
      - CONNECTOR_SCOPE=IPv4-Addr,IPv6-Addr,Domain-Name
      - CONNECTOR_LOG_LEVEL=error
      - CONNECTOR_TYPE=INTERNAL_ENRICHMENT
      - MALBEACON_API_KEY=${CONNECTOR_MALBEACON_KEY} # Required
      - MALBEACON_API_BASE_URL=https://api.malbeacon.com/v1/ # Required
      - MALBEACON_INDICATOR_SCORE_LEVEL=50 # Optional
      - MALBEACON_MAX_TLP=TLP:AMBER # Required, Available values: TLP:CLEAR, TLP:WHITE, TLP:GREEN, TLP:AMBER, TLP:AMBER+STRICT, TLP:RED
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    networks:
      - cti-net

  connector-ipinfo:
    image: opencti/connector-ipinfo:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_IPINFO_ID}
      - CONNECTOR_NAME=IpInfo
      - CONNECTOR_SCOPE=IPv4-Addr,IPv6-Addr
      - CONNECTOR_AUTO=true
      - CONNECTOR_CONFIDENCE_LEVEL=75 # From 0 (Unknown) to 100 (Fully trusted)
      - CONNECTOR_LOG_LEVEL=error
      - CONNECTOR_TYPE=INTERNAL_ENRICHMENT
      - IPINFO_TOKEN=${CONNECTOR_IPINFO_KEY}
      - IPINFO_MAX_TLP=TLP:AMBER # "TLP:CLEAR", "TLP:GREEN", "TLP:AMBER", "TLP:AMBER+STRICT", "TLP:RED"
      - IPINFO_USE_ASN_NAME=true # Set false if you want ASN name to be just the number e.g. AS8075
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    networks:
      - cti-net

  ###########################
  # OPENCTI DEFAULT DATA    #
  ###########################

  connector-opencti:
    image: opencti/connector-opencti:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_OPENCTI_ID}
      - "CONNECTOR_NAME=OpenCTI Datasets"
      - CONNECTOR_SCOPE=marking-definition,identity,location
      - CONNECTOR_AUTO_CREATE_SERVICE_ACCOUNT=true
      - CONNECTOR_AUTO_CREATE_SERVICE_ACCOUNT_CONFIDENCE_LEVEL=100
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    networks:
      - cti-net
  connector-mitre:
    image: opencti/connector-mitre:latest
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_MITRE_ID}
      - CONNECTOR_AUTO_CREATE_SERVICE_ACCOUNT=true
      - CONNECTOR_AUTO_CREATE_SERVICE_ACCOUNT_CONFIDENCE_LEVEL=75
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
    restart: always
    depends_on:
      opencti:
        condition: service_healthy
    networks:
      - cti-net

  ###########################
  # OPENAEV                 #
  ###########################

  openaev:
    image: openaev/platform:latest
    environment:
      - OPENAEV_BASE-URL=${OPENAEV_EXTERNAL_SCHEME}://${OPENAEV_HOST}:${OPENAEV_PORT}
      - OPENAEV_AUTH-LOCAL-ENABLE=true
      - OPENAEV_ADMIN_EMAIL=${OPENAEV_ADMIN_EMAIL}
      - OPENAEV_ADMIN_PASSWORD=${OPENAEV_ADMIN_PASSWORD}
      - OPENAEV_ADMIN_TOKEN=${OPENAEV_ADMIN_TOKEN}
      - OPENAEV_ADMIN_ENCRYPTION_SALT=${OPENAEV_ADMIN_ENCRYPTION_SALT}
      - OPENAEV_ADMIN_ENCRYPTION_PASSWORD=${OPENAEV_ADMIN_ENCRYPTION_PASSWORD}
      - OPENAEV_ADMIN_ENCRYPTION_KEY=${OPENAEV_ADMIN_ENCRYPTION_PASSWORD}
      - OPENAEV_HEALTHCHECK_KEY=${OPENAEV_HEALTHCHECK_KEY}
      - OPENAEV_EXTRA-TRUSTED-CERTS-DIR=/opt/openaev/additional_certs
      - SPRING_DATASOURCE_URL=jdbc:postgresql://infra-postgres:5432/openaev
      # Using shared credentials defined in infra/init-dbs.sh
      # Defaults: openaev / changeme
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-openaev}
      - SPRING_DATASOURCE_PASSWORD=${OPENAEV_DB_PASSWORD}
      - MINIO_ENDPOINT=minio
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - OPENAEV_RABBITMQ_HOSTNAME=rabbitmq
      - OPENAEV_RABBITMQ_USER=${RABBITMQ_DEFAULT_USER}
      - OPENAEV_RABBITMQ_PASS=${RABBITMQ_DEFAULT_PASS}
      - SPRING_MAIL_HOST=${SMTP_HOST}
      - SPRING_MAIL_PORT=${SMTP_PORT}
      - SPRING_MAIL_USERNAME=${SMTP_USERNAME}
      - SPRING_MAIL_PASSWORD=${SMTP_PASSWORD}
      - SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH=${SMTP_AUTH}
      - SPRING_MAIL_PROPERTIES_MAIL_SMTP_SSL_ENABLE=${SMTP_SSL_ENABLE}
      - SPRING_MAIL_PROPERTIES_MAIL_SMTP_SSL_TRUST=*
      - SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE=${SMTP_STARTTLS_ENABLE}
      - OPENAEV_MAIL_IMAP_ENABLED=${OPENAEV_MAIL_IMAP_ENABLED}
      - OPENAEV_MAIL_IMAP_HOST=${IMAP_HOST}
      - OPENAEV_MAIL_IMAP_PORT=${IMAP_PORT}
      - OPENAEV_MAIL_IMAP_USERNAME=${IMAP_USERNAME}
      - OPENAEV_MAIL_IMAP_PASSWORD=${IMAP_PASSWORD}
      - OPENAEV_MAIL_IMAP_AUTH=${IMAP_AUTH}
      - OPENAEV_MAIL_IMAP_SSL_ENABLE=${IMAP_SSL_ENABLE}
      - OPENAEV_MAIL_IMAP_SSL_TRUST=*
      - OPENAEV_MAIL_IMAP_STARTTLS_ENABLE=${IMAP_STARTTLS_ENABLE}
      # OpenCTI
      - OPENAEV_XTM_OPENCTI_ENABLE=true
      - OPENAEV_XTM_OPENCTI_URL=${OPENCTI_EXTERNAL_SCHEME}://${OPENCTI_HOST}:${OPENCTI_PORT}
      - OPENAEV_XTM_OPENCTI_API_URL=http://opencti:8080
      - OPENAEV_XTM_OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      # ES CTI infra
      - ENGINE_URL=http://es8-cti:9200
    networks:
      - cti-net
    ports:
      - "8082:8080" # If you change the host port (the left one) do not forget to update OPENAEV_BASE-URL in you .env
    depends_on:
      # pgsql: REMOVED (Shared Infra)
      #   condition: service_healthy
      minio:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      # ES infra stack
      # elasticsearch:
      #   condition: service_healthy
    restart: always
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://openaev:8080/api/health?health_access_key=${OPENAEV_HEALTHCHECK_KEY}" ]
      interval: 10s
      timeout: 5s
      retries: 20

  ###########################
  # OPENAEV COLLECTORS      #
  ###########################

  collector-mitre-attack:
    image: openaev/collector-mitre-attack:latest
    environment:
      - OPENAEV_URL=http://openaev:8080
      - OPENAEV_TOKEN=${OPENAEV_ADMIN_TOKEN}
      - COLLECTOR_ID=${COLLECTOR_MITRE_ATTACK_ID} # Valid UUIDv4
      - "COLLECTOR_NAME=MITRE ATT&CK"
    depends_on:
      openaev:
        condition: service_healthy # Wait for healthcheck
    networks:
      - cti-net
    restart: always
  collector-openaev:
    image: openaev/collector-openaev:latest
    environment:
      - OPENAEV_URL=http://openaev:8080
      - OPENAEV_TOKEN=${OPENAEV_ADMIN_TOKEN}
      - COLLECTOR_ID=${COLLECTOR_OPENAEV_ID} # Valid UUIDv4
      - "COLLECTOR_NAME=OpenAEV Datasets"
    depends_on:
      openaev:
        condition: service_healthy # Wait for healthcheck
    networks:
      - cti-net
    restart: always
  collector-atomic-red-team:
    image: openaev/collector-atomic-red-team:latest
    environment:
      - OPENAEV_URL=http://openaev:8080
      - OPENAEV_TOKEN=${OPENAEV_ADMIN_TOKEN}
      - COLLECTOR_ID=${COLLECTOR_ATOMIC_RED_TEAM_ID} # Valid UUIDv4
      - "COLLECTOR_NAME=Atomic Red Team"
    depends_on:
      openaev:
        condition: service_healthy # Wait for healthcheck
    networks:
      - cti-net
    restart: always
  collector-nvd-nist-cve:
    image: openaev/collector-nvd-nist-cve:latest
    environment:
      - OPENAEV_URL=http://openaev:8080
      - OPENAEV_TOKEN=${OPENAEV_ADMIN_TOKEN}
      - COLLECTOR_ID=${COLLECTOR_NVD_NIST_CVE_ID} # Valid UUIDv4
      - NVD_NIST_CVE_API_KEY=${COLLECTOR_NVD_NIST_CVE_API_KEY}
      - "COLLECTOR_NAME=CVE by NVD NIST"
    depends_on:
      openaev:
        condition: service_healthy # Wait for healthcheck
    networks:
      - cti-net
    restart: always

  ###########################
  # OPENAEV INJECTORS       #
  ###########################

  injector-nmap:
    image: openaev/injector-nmap:latest
    environment:
      - OPENAEV_URL=http://openaev:8080
      - OPENAEV_TOKEN=${OPENAEV_ADMIN_TOKEN}
      - INJECTOR_ID=${INJECTOR_NMAP_ID} # Valid UUIDv4
      - "INJECTOR_NAME=Nmap"
    depends_on:
      openaev:
        condition: service_healthy
    restart: always
    networks:
      - cti-net
  injector-nuclei:
    image: openaev/injector-nuclei:latest
    environment:
      - OPENAEV_URL=http://openaev:8080
      - OPENAEV_TOKEN=${OPENAEV_ADMIN_TOKEN}
      - INJECTOR_ID=${INJECTOR_NUCLEI_ID} # Valid UUIDv4
      - "INJECTOR_NAME=Nuclei"
    depends_on:
      openaev:
        condition: service_healthy
    restart: always
    networks:
      - cti-net

volumes:
  # esdata: # no local ES in this stack anymore
  pgsqldata:
  s3data:
  redisdata:
  amqpdata:
  rsakeys:


networks:
  cti-net:
    external: true
    name: cti-net # Explicit name overrides project prefix
