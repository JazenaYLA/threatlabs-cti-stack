name: Deploy (Development Only)

on:
  push:
    branches: ["main", "auto-swapper"]
  # Explicitly block main
  workflow_dispatch:
    inputs:
      confirm_branch:
        description: 'Only runs on auto-swapper' # ‚Üê CHANGED from "main"
        required: true

jobs:
  deploy:
    runs-on: local-shell
    # Safety check
    if: github.ref == 'refs/heads/auto-swapper'
    
    steps:
      - name: Branch Safety Check
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "‚ùå ERROR: This workflow cannot run on main branch"
            echo "Production deployments must be manual"
            exit 1
          fi
          echo "‚úÖ Running on development branch: ${{ github.ref_name }}"

      - name: Checkout Code
        uses: actions/checkout@v4

      # --- CHANGED STEP: Install Latest Docker Manually ---
      - name: Set Environment Variables
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "DOCKGE_ROOT=/opt/stacks" >> $GITHUB_ENV
            echo "ENV_NAME=production" >> $GITHUB_ENV
          else
            echo "DOCKGE_ROOT=/opt/cti-dev" >> $GITHUB_ENV
            echo "ENV_NAME=development" >> $GITHUB_ENV
          fi

      - name: Sync Files to Server
        run: |
          echo "üöÄ Syncing files to ${{ env.DOCKGE_ROOT }} (${{ env.ENV_NAME }})..."
          tar --exclude='.git' --exclude='forgejo-runner' -c . | \
          docker run -i --rm -v ${{ env.DOCKGE_ROOT }}:/target alpine tar x -C /target

      - name: Reset Workspace Ownership
        run: |
          echo "üîß Resetting all files to gravity (1000:1000)..."
          docker run --rm -v ${{ env.DOCKGE_ROOT }}:/target alpine chown -R 1000:1000 /target

      - name: Apply Service Permissions
        run: |
          echo "üîß Applying special service permissions..."
          # Run fix-permissions.sh BEFORE containers start
          docker run --rm \
            -v ${{ env.DOCKGE_ROOT }}:/target \
            -w /target \
            alpine sh ./fix-permissions.sh

      - name: Start Stacks
        run: |
          # Define the exact deployment order based on dependencies
          DEPLOY_ORDER="infra misp-modules misp thehive xtm flowintel dfir-iris shuffle ail-project lacus n8n flowise"

          for stack_name in $DEPLOY_ORDER; do
              if [ -d "${{ env.DOCKGE_ROOT }}/$stack_name" ]; then
                  if [ -f "${{ env.DOCKGE_ROOT }}/$stack_name/compose.yaml" ] || [ -f "${{ env.DOCKGE_ROOT }}/$stack_name/docker-compose.yml" ]; then
                      echo "‚úÖ Starting $stack_name..."
                      cd "${{ env.DOCKGE_ROOT }}/$stack_name"
                      
                      docker compose pull
                      docker compose up -d --remove-orphans
                  else
                      echo "‚ö†Ô∏è  Skipping $stack_name (No compose file found)"
                  fi
              fi
          done

      - name: Cleanup
        run: |
          echo "üéâ Deployment Complete!"