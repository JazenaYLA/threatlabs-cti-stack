name: Deploy Monorepo (Mixed Filenames)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: local-shell
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Tools
        run: apk add --no-cache docker-cli docker-compose rsync

      - name: Deploy Stacks
        run: |
          # 1. Define Root
          DOCKGE_ROOT="/opt/stacks"
          
          # 2. Sync Files (Exclude .git and the runner itself)
          echo "üìÇ Syncing files to $DOCKGE_ROOT..."
          rsync -av --delete --exclude='.git' --exclude='forgejo-runner' ./ $DOCKGE_ROOT/

          # 3. Loop through every folder in the root
          cd $DOCKGE_ROOT
          for d in */ ; do
              # Remove trailing slash (e.g., "cortex/" -> "cortex")
              stack_name=${d%/}
              
              # SKIP the runner folder explicitly
              if [ "$stack_name" == "forgejo-runner" ]; then continue; fi

              echo "üîç Checking $stack_name..."
              
              # CHECK 1: Preferred Name
              if [ -f "$stack_name/compose.yml" ]; then
                  echo "‚úÖ Found compose.yml in $stack_name. Updating..."
                  cd "$DOCKGE_ROOT/$stack_name"
                  docker compose pull
                  docker compose up -d --remove-orphans
                  cd $DOCKGE_ROOT

              # CHECK 2: Legacy Name
              elif [ -f "$stack_name/docker-compose.yml" ]; then
                  echo "‚úÖ Found docker-compose.yml in $stack_name. Updating..."
                  cd "$DOCKGE_ROOT/$stack_name"
                  docker compose pull
                  docker compose up -d --remove-orphans
                  cd $DOCKGE_ROOT
                  
              else
                  echo "‚ö†Ô∏è  No compose file in $stack_name. Skipping."
              fi
          done
          
          echo "üéâ All stacks processed!"