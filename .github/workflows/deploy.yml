name: Deploy (Version Fix)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: local-shell
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- CHANGED STEP: Install Latest Docker Manually ---
      - name: Install Latest Docker Tools
        run: |
          # 1. Install basics
          apk add --no-cache curl tar

          # 2. Download Latest Docker CLI (Static Binary)
          echo "‚¨áÔ∏è Downloading Docker v26.1.3..."
          curl -fsSL https://download.docker.com/linux/static/stable/x86_64/docker-26.1.3.tgz -o docker.tgz
          
          # 3. Extract and Install
          tar -xzf docker.tgz
          mv docker/docker /usr/local/bin/docker
          rm -rf docker docker.tgz
          
          # 4. Install Docker Compose Plugin (v2.27.0)
          echo "‚¨áÔ∏è Downloading Docker Compose v2.27.0..."
          mkdir -p /usr/local/lib/docker/cli-plugins
          curl -SL https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-linux-x86_64 -o /usr/local/lib/docker/cli-plugins/docker-compose
          chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
          
          # 5. Verify Versions
          echo "‚úÖ Versions Installed:"
          docker --version
          docker compose version

      - name: Fix Source Permissions
        run: |
          echo "üîß Fixing workspace permissions..."
          chmod -R u+rwX,go+rX .

      - name: Deploy Stacks
        run: |
          DOCKGE_ROOT="/opt/stacks"
          
          echo "üöÄ Starting Deployment to $DOCKGE_ROOT..."
          
          # Use Docker to write files (Bypasses Host/LXC permission issues)
          tar --exclude='.git' --exclude='forgejo-runner' -c . | \
          docker run -i --rm -v ${DOCKGE_ROOT}:/target alpine tar x -C /target
          
          # Update Stacks
          cd "$DOCKGE_ROOT"
          
          for d in */ ; do
              stack_name=${d%/}
              
              if [ "$stack_name" == "forgejo-runner" ]; then continue; fi
              
              if [ -f "$stack_name/compose.yaml" ] || [ -f "$stack_name/docker-compose.yml" ]; then
                  echo "‚úÖ Updating $stack_name..."
                  cd "$DOCKGE_ROOT/$stack_name"
                  docker compose pull
                  docker compose up -d --remove-orphans
                  cd "$DOCKGE_ROOT"
              fi
          done

      - name: Restore Service Permissions
        run: |
          echo "üîß Re-applying special service permissions..."
          DOCKGE_ROOT="/opt/stacks"
          
          # Run the fix script using a temporary Alpine container (as Root)
          # This works around the runner's lack of sudo privileges
          docker run --rm \
            -v ${DOCKGE_ROOT}:/target \
            -w /target \
            alpine sh ./fix-permissions.sh
          
          echo "üéâ Deployment Complete!"