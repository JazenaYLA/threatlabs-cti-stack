name: Deploy (Final Fix)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: local-shell
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Tools
        run: apk add --no-cache docker-cli docker-compose tar

      # --- NEW STEP: Fix Read Permissions ---
      - name: Fix Source Permissions
        run: |
          echo "ðŸ”§ Fixing workspace permissions..."
          # Force all files to be readable/writable by the current user
          chmod -R u+rwX,go+rX .
          ls -la  # Verify we can see the files now

      - name: Deploy Stacks
        run: |
          DOCKGE_ROOT="/opt/stacks"
          
          echo "ðŸš€ Starting Deployment to $DOCKGE_ROOT..."
          
          # Use Docker to write files (Bypasses Host/LXC permission issues)
          # We pipe the tar stream directly into a container mapped to the host
          tar --exclude='.git' --exclude='forgejo-runner' -c . | \
          docker run -i --rm -v ${DOCKGE_ROOT}:/target alpine tar x -C /target
          
          # Update Stacks
          cd "$DOCKGE_ROOT"
          
          for d in */ ; do
              stack_name=${d%/}
              
              if [ "$stack_name" == "forgejo-runner" ]; then continue; fi
              
              if [ -f "$stack_name/compose.yaml" ] || [ -f "$stack_name/docker-compose.yml" ]; then
                  echo "âœ… Updating $stack_name..."
                  cd "$DOCKGE_ROOT/$stack_name"
                  docker compose pull
                  docker compose up -d --remove-orphans
                  cd "$DOCKGE_ROOT"
              fi
          done
          
          echo "ðŸŽ‰ Deployment Complete!"