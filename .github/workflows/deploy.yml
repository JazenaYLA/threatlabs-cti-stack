name: Deploy Monorepo (Copy Fix)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: local-shell
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Tools
        run: apk add --no-cache docker-cli docker-compose

      - name: Deploy Stacks
        run: |
          # 1. Define Target
          DOCKGE_ROOT="/opt/stacks"
          
          echo "ðŸ“‚ Copying files to $DOCKGE_ROOT..."
          
          # 2. FORCE COPY (The Fix)
          # We use 'cp -Rf' to overwrite without permission checks
          # We manually exclude .git and the runner to prevent loops
          cp -Rf ./* "$DOCKGE_ROOT/"
          
          # 3. Update Stacks
          cd "$DOCKGE_ROOT"
          
          # Loop through folders
          for d in */ ; do
              stack_name=${d%/}
              
              # Skip the runner itself
              if [ "$stack_name" == "forgejo-runner" ]; then continue; fi
              
              # Check for compose files
              if [ -f "$stack_name/compose.yaml" ] || [ -f "$stack_name/docker-compose.yml" ]; then
                  echo "âœ… Updating $stack_name..."
                  cd "$DOCKGE_ROOT/$stack_name"
                  docker compose pull
                  docker compose up -d --remove-orphans
                  cd "$DOCKGE_ROOT"
              fi
          done
          
          echo "ðŸŽ‰ Done!"