name: Deploy via Docker Pipe

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: local-shell
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Tools
        run: apk add --no-cache docker-cli docker-compose tar

      - name: Deploy Stacks
        run: |
          # 1. Define Target
          DOCKGE_ROOT="/opt/stacks"
          
          echo "ðŸš€ Starting Deployment to $DOCKGE_ROOT..."
          
          # ---------------------------------------------------------
          # THE FIX: Use Docker to write the files (Bypasses Permissions)
          # We tar the current files and pipe them into a helper container
          # ---------------------------------------------------------
          echo "ðŸ“¦ Piping files to Host..."
          tar --exclude='.git' --exclude='forgejo-runner' -c . | \
          docker run -i --rm -v ${DOCKGE_ROOT}:/target alpine tar x -C /target
          
          # 2. Update Stacks
          # We can traverse directories because of the 777 permissions
          cd "$DOCKGE_ROOT"
          
          for d in */ ; do
              stack_name=${d%/}
              
              if [ "$stack_name" == "forgejo-runner" ]; then continue; fi
              
              if [ -f "$stack_name/compose.yaml" ] || [ -f "$stack_name/docker-compose.yml" ]; then
                  echo "âœ… Updating $stack_name..."
                  cd "$DOCKGE_ROOT/$stack_name"
                  docker compose pull
                  docker compose up -d --remove-orphans
                  cd "$DOCKGE_ROOT"
              fi
          done
          
          echo "ðŸŽ‰ Deployment Complete!"