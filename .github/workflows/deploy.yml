name: Deploy Monorepo (Root Fix)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: local-shell
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Tools
        run: apk add --no-cache docker-cli docker-compose rsync

      - name: Deploy Stacks
        run: |
          # --- CONFIGURATION ---
          # We deploy directly to the Dockge Root, not a subfolder
          DOCKGE_ROOT="/opt/stacks"
          
          echo "üìÇ Syncing Git Repo to $DOCKGE_ROOT..."
          
          # 1. SYNC FILES
          # We use --no-owner --no-group to prevent permission errors on the host
          # We exclude the .git folder and the runner itself
          rsync -av --no-owner --no-group \
            --exclude='.git' \
            --exclude='forgejo-runner' \
            --exclude='README.md' \
            ./ "$DOCKGE_ROOT/"

          # 2. UPDATE STACKS
          cd "$DOCKGE_ROOT"
          
          # Loop through every folder in /opt/stacks
          for d in */ ; do
              # Clean up directory name (remove trailing slash)
              stack_name=${d%/}
              
              # Skip the runner folder (don't restart the hand that feeds you)
              if [ "$stack_name" == "forgejo-runner" ]; then continue; fi

              # Check for Compose files
              if [ -f "$stack_name/compose.yaml" ]; then
                  echo "‚úÖ [compose.yaml] Updating $stack_name..."
                  cd "$DOCKGE_ROOT/$stack_name"
                  docker compose pull
                  docker compose up -d --remove-orphans
                  cd "$DOCKGE_ROOT"

              elif [ -f "$stack_name/docker-compose.yml" ]; then
                  echo "‚úÖ [docker-compose.yml] Updating $stack_name..."
                  cd "$DOCKGE_ROOT/$stack_name"
                  docker compose pull
                  docker compose up -d --remove-orphans
                  cd "$DOCKGE_ROOT"
              
              # Optional: Log skips to reduce noise
              # else
              #    echo "‚è≠Ô∏è  Skipping $stack_name (No compose file)"
              fi
          done
          
          echo "üéâ Deployment Complete!"